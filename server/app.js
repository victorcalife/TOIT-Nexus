/**
 * SERVIDOR EXPRESS PRINCIPAL ROBUSTO
 * Sistema completo e unificado para TOIT Nexus
 * 100% JavaScript - SEM TYPESCRIPT
 */

// Carregar vari√°veis de ambiente - priorizar .env.local para desenvolvimento
const fs = require('fs');
const path = require('path');

// Verificar se existe .env.local e carregar primeiro
const envLocalPath = path.join(__dirname, '.env.local');
if (fs.existsSync(envLocalPath)) {
  console.log('üîß Carregando configura√ß√µes de desenvolvimento (.env.local)');
  require('dotenv').config({ path: envLocalPath });
} else {
  console.log('üîß Carregando configura√ß√µes padr√£o (.env)');
  require('dotenv').config();
}
const express = require( 'express' );
const cors = require( 'cors' );
const helmet = require( 'helmet' );
const compression = require( 'compression' );
const cookieParser = require( 'cookie-parser' );
const rateLimit = require( 'express-rate-limit' );

// Importar configura√ß√µes e sistemas
const { db } = require( './database-config' );
const { setupRoutes } = require( './routes/index' );

/**
 * CLASSE PRINCIPAL DO SERVIDOR
 */
class TOITNexusServer
{
  constructor()
  {
    this.app = express();
    this.port = process.env.PORT || 8080;
    this.environment = process.env.NODE_ENV || 'development';
    this.server = null;

    console.log( 'üöÄ Inicializando TOIT Nexus Server...' );
    console.log( `üìç Ambiente: ${ this.environment }` );
    console.log( `üîß Porta: ${ this.port }` );
  }

  /**
   * CONFIGURAR MIDDLEWARES DE SEGURAN√áA
   */
  setupSecurity()
  {
    console.log( 'üõ°Ô∏è Configurando seguran√ßa...' );

    // Helmet para headers de seguran√ßa
    this.app.use( helmet( {
      contentSecurityPolicy: {
        directives: {
          defaultSrc: [ "'self'" ],
          styleSrc: [ "'self'", "'unsafe-inline'", "https://fonts.googleapis.com" ],
          fontSrc: [ "'self'", "https://fonts.gstatic.com" ],
          imgSrc: [ "'self'", "data:", "https:" ],
          scriptSrc: [ "'self'", "'unsafe-inline'", "'unsafe-eval'" ],
          connectSrc: [ "'self'", "ws:", "wss:", "https:" ],
          objectSrc: [ "'none'" ],
          mediaSrc: [ "'self'" ],
          frameSrc: [ "'none'" ]
        }
      },
      crossOriginEmbedderPolicy: false
    } ) );

    // CORS configurado
    const corsOptions = {
      origin: ( origin, callback ) =>
      {
        const allowedOrigins = this.environment === 'production'
          ? [
            'https://nexus.toit.com.br',
            'https://supnexus.toit.com.br',
            'https://api.toit.com.br'
          ]
          : [
            'http://localhost:3000',
            'http://localhost:5173',
            'http://localhost:8080',
            'http://127.0.0.1:3000',
            'http://127.0.0.1:5173',
            'http://127.0.0.1:8080'
          ];

        // Permitir requisi√ß√µes sem origin (Postman, mobile apps, etc.)
        if ( !origin ) return callback( null, true );

        if ( allowedOrigins.includes( origin ) )
        {
          callback( null, true );
        } else
        {
          console.warn( `üö´ CORS bloqueado para origin: ${ origin }` );
          callback( new Error( 'N√£o permitido pelo CORS' ) );
        }
      },
      credentials: true,
      methods: [ 'GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS' ],
      allowedHeaders: [
        'Content-Type',
        'Authorization',
        'X-Requested-With',
        'Accept',
        'Origin',
        'Cache-Control',
        'X-File-Name'
      ],
      exposedHeaders: [ 'X-Total-Count', 'X-Page-Count' ],
      maxAge: 86400 // 24 horas
    };

    this.app.use( cors( corsOptions ) );

    // Trust proxy para Railway/Heroku
    this.app.set( 'trust proxy', 1 );

    console.log( '‚úÖ Seguran√ßa configurada' );
  }

  /**
   * CONFIGURAR MIDDLEWARES B√ÅSICOS
   */
  setupMiddlewares()
  {
    console.log( 'üîß Configurando middlewares...' );

    // Compress√£o
    this.app.use( compression() );

    // Cookie parser
    this.app.use( cookieParser() );

    // Rate limiting global
    const globalLimiter = rateLimit( {
      windowMs: 15 * 60 * 1000, // 15 minutos
      max: this.environment === 'production' ? 1000 : 10000, // Mais permissivo em dev
      message: {
        success: false,
        error: 'Muitas requisi√ß√µes. Tente novamente em 15 minutos.',
        code: 'RATE_LIMIT_EXCEEDED'
      },
      standardHeaders: true,
      legacyHeaders: false,
      skip: ( req ) =>
      {
        // Pular rate limiting para health checks
        return req.path === '/api/health' || req.path === '/health';
      }
    } );

    this.app.use( '/api', globalLimiter );

    // Parsing de dados
    this.app.use( express.json( {
      limit: '50mb',
      verify: ( req, res, buf ) =>
      {
        // Salvar raw body para webhooks
        if ( req.path.includes( '/webhooks/' ) )
        {
          req.rawBody = buf;
        }
      }
    } ) );

    this.app.use( express.urlencoded( {
      extended: true,
      limit: '50mb'
    } ) );

    // Middleware de logging
    this.app.use( ( req, res, next ) =>
    {
      const start = Date.now();
      const requestId = Math.random().toString( 36 ).substr( 2, 9 );

      req.requestId = requestId;
      req.startTime = start;

      // Log da requisi√ß√£o
      console.log( `üì• [${ requestId }] ${ req.method } ${ req.path } - ${ req.ip }` );

      // Log da resposta
      const originalSend = res.send;
      res.send = function ( data )
      {
        const duration = Date.now() - start;
        console.log( `üì§ [${ requestId }] ${ res.statusCode } - ${ duration }ms` );
        originalSend.call( this, data );
      };

      next();
    } );

    // Middleware para adicionar headers √∫teis
    this.app.use( ( req, res, next ) =>
    {
      res.setHeader( 'X-Powered-By', 'TOIT-Nexus' );
      res.setHeader( 'X-API-Version', '2.0.0' );
      res.setHeader( 'X-Request-ID', req.requestId );
      next();
    } );

    console.log( '‚úÖ Middlewares configurados' );
  }

  /**
   * CONFIGURAR ROTAS
   */
  setupRoutes()
  {
    console.log( 'üõ£Ô∏è Configurando rotas...' );

    // Health check b√°sico
    this.app.get( '/health', ( req, res ) =>
    {
      res.json( {
        success: true,
        service: 'TOIT Nexus',
        version: '2.0.0',
        status: 'healthy',
        timestamp: new Date().toISOString(),
        environment: this.environment,
        uptime: process.uptime(),
        memory: process.memoryUsage(),
        requestId: req.requestId
      } );
    } );

    // Rota raiz
    this.app.get( '/', ( req, res ) =>
    {
      res.json( {
        success: true,
        message: 'TOIT Nexus API est√° funcionando',
        version: '2.0.0',
        environment: this.environment,
        documentation: '/api/docs',
        health: '/health',
        timestamp: new Date().toISOString()
      } );
    } );

    // Configurar todas as rotas da API
    setupRoutes( this.app );

    // Servir arquivos est√°ticos (sempre, n√£o apenas em produ√ß√£o)
    const clientPath = path.join( __dirname, '../client/dist' );

    console.log( `üìÅ Servindo arquivos est√°ticos de: ${ clientPath }` );

    this.app.use( express.static( clientPath, {
      maxAge: this.environment === 'production' ? '1d' : '0',
      etag: true,
      lastModified: true,
      index: false // N√£o servir index.html automaticamente
    } ) );

    // Catch-all para SPA (Single Page Application)
    this.app.get( '*', ( req, res ) =>
    {
      // N√£o interceptar rotas da API
      if ( req.path.startsWith( '/api/' ) )
      {
        return res.status( 404 ).json( {
          success: false,
          error: 'Endpoint da API n√£o encontrado',
          code: 'API_NOT_FOUND',
          path: req.path
        } );
      }

      // Servir index.html para todas as outras rotas (SPA)
      const indexPath = path.join( clientPath, 'index.html' );
      console.log( `üìÑ Servindo SPA: ${ req.path } -> ${ indexPath }` );
      res.sendFile( indexPath );
    } );

    console.log( '‚úÖ Rotas configuradas' );
  }

  /**
   * CONFIGURAR TRATAMENTO DE ERROS
   */
  setupErrorHandling()
  {
    console.log( 'üõ°Ô∏è Configurando tratamento de erros...' );

    // 404 para rotas n√£o encontradas
    this.app.use( '*', ( req, res ) =>
    {
      res.status( 404 ).json( {
        success: false,
        error: 'Rota n√£o encontrada',
        code: 'NOT_FOUND',
        path: req.originalUrl,
        method: req.method,
        requestId: req.requestId
      } );
    } );

    // Error handler global
    this.app.use( ( error, req, res, next ) =>
    {
      console.error( `üí• [ERROR] ${ req.requestId || 'unknown' } - ${ error.stack }` );

      // Erro de CORS
      if ( error.message.includes( 'CORS' ) )
      {
        return res.status( 403 ).json( {
          success: false,
          error: 'Acesso negado pelo CORS',
          code: 'CORS_ERROR',
          requestId: req.requestId
        } );
      }

      // Erro de parsing JSON
      if ( error.type === 'entity.parse.failed' )
      {
        return res.status( 400 ).json( {
          success: false,
          error: 'JSON inv√°lido na requisi√ß√£o',
          code: 'INVALID_JSON',
          requestId: req.requestId
        } );
      }

      // Erro de limite de tamanho
      if ( error.code === 'LIMIT_FILE_SIZE' )
      {
        return res.status( 413 ).json( {
          success: false,
          error: 'Arquivo muito grande',
          code: 'FILE_TOO_LARGE',
          requestId: req.requestId
        } );
      }

      // Erro gen√©rico
      const statusCode = error.statusCode || error.status || 500;

      res.status( statusCode ).json( {
        success: false,
        error: this.environment === 'production'
          ? 'Erro interno do servidor'
          : error.message,
        code: 'INTERNAL_ERROR',
        requestId: req.requestId,
        ...( this.environment === 'development' && {
          stack: error.stack,
          details: error
        } )
      } );
    } );

    console.log( '‚úÖ Tratamento de erros configurado' );
  }

  /**
   * VERIFICAR CONEX√ÉO COM BANCO DE DADOS
   */
  async checkDatabase()
  {
    try
    {
      console.log( 'üóÑÔ∏è Verificando conex√£o com banco de dados...' );

      await db.connect();

      // Verificar integridade do banco
      const integrity = await db.checkIntegrity();

      if ( integrity.missingTables.length > 0 )
      {
        console.warn( '‚ö†Ô∏è Algumas tabelas est√£o faltando:', integrity.missingTables );
        console.log( 'üîß Executando migrations...' );
        await db.runMigrations();
      }

      console.log( '‚úÖ Banco de dados conectado e verificado' );
      return true;
    } catch ( error )
    {
      console.error( '‚ùå Erro na conex√£o com banco de dados:', error.message );
      throw error;
    }
  }

  /**
   * CONFIGURAR GRACEFUL SHUTDOWN
   */
  setupGracefulShutdown()
  {
    const shutdown = async ( signal ) =>
    {
      console.log( `\nüõë Recebido sinal ${ signal }. Iniciando shutdown graceful...` );

      if ( this.server )
      {
        this.server.close( async () =>
        {
          console.log( 'üîí Servidor HTTP fechado' );

          try
          {
            await db.close();
            console.log( 'üóÑÔ∏è Conex√£o com banco fechada' );
          } catch ( error )
          {
            console.error( '‚ùå Erro ao fechar banco:', error );
          }

          console.log( '‚úÖ Shutdown completo' );
          process.exit( 0 );
        } );
      } else
      {
        process.exit( 0 );
      }
    };

    process.on( 'SIGTERM', () => shutdown( 'SIGTERM' ) );
    process.on( 'SIGINT', () => shutdown( 'SIGINT' ) );

    // Capturar erros n√£o tratados
    process.on( 'uncaughtException', ( error ) =>
    {
      console.error( 'üí• Erro n√£o capturado:', error );
      shutdown( 'uncaughtException' );
    } );

    process.on( 'unhandledRejection', ( reason, promise ) =>
    {
      console.error( 'üí• Promise rejeitada n√£o tratada:', reason );
      shutdown( 'unhandledRejection' );
    } );
  }

  /**
   * INICIAR SERVIDOR
   */
  async start()
  {
    try
    {
      console.log( 'üöÄ Iniciando TOIT Nexus Server...' );

      // Verificar banco de dados
      await this.checkDatabase();

      // Configurar servidor
      this.setupSecurity();
      this.setupMiddlewares();
      this.setupRoutes();
      this.setupErrorHandling();
      this.setupGracefulShutdown();

      // Iniciar servidor
      this.server = this.app.listen( this.port, '0.0.0.0', () =>
      {
        console.log( '\nüéâ TOIT NEXUS SERVER INICIADO COM SUCESSO!' );
        console.log( '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê' );
        console.log( `üåê URL: https://api.toit.com.br:${ this.port }` );
        console.log( `üìä Health: https://api.toit.com.br:${ this.port }/health` );
        console.log( `üîê API: https://api.toit.com.br:${ this.port }` );
        console.log( `üìã Ambiente: ${ this.environment }` );
        console.log( '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' );
      } );

      return this.server;

    } catch ( error )
    {
      console.error( 'üí• Erro ao iniciar servidor:', error );
      process.exit( 1 );
    }
  }
}

// Iniciar servidor se executado diretamente
if ( require.main === module )
{
  const server = new TOITNexusServer();
  server.start();
}

module.exports = { TOITNexusServer };
